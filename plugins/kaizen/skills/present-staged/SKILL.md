---
name: present-staged
user-invocable: false
description: |
  項目の段階的・対話的提示。AI専用Skill。
  項目（レビュー指摘、検証結果、調査結果、質問への回答等）を対話3原則に従って丁寧に提示する。
  1件でも有効（提示品質の向上）。2件以上では段階的に1件ずつ提示。
  用途1: /kaizen:review Skill からのレビュー結果ファイル提示
  用途2: AI が分析・調査・回答で項目を提示する場合（--inline）
argument-hint: "<review-result-file-path> | --inline"
---

# /present-staged Skill

複数項目を段階的・対話的にユーザーに提示する AI 専用 Skill。
ファイル入力（レビュー結果等）とコンテキスト入力（--inline）の両方に対応し、内容に応じて適切に提示する。

## 入力仕様 [MANDATORY]

### 入力方法

| `$ARGUMENTS` | 入力方法 |
|--------------|---------|
| ファイルパス | ファイルから Read で読み込み |
| `--inline` | 直前の会話コンテキストから取得 |

### ファイル入力

`$ARGUMENTS` = ファイルパス

ファイル形式: YAML frontmatter + Markdown body

```markdown
---
review_type: code
engine: codex
target_files:
  - App/View/FooView.swift
reference_docs:
  - review_criteria.md
timestamp: "2026-02-11T14:30:22Z"
---

### 🔴致命的問題
1. **問題名**: 説明
   - 箇所: ファイル:行
   - 参照: 関連ルール
   - 修正案: 具体的な修正

### 🟡品質問題
...

### 🟢改善提案
...

### サマリー
- 🔴致命的: X件
- 🟡品質: X件
- 🟢改善: X件
```

### コンテキスト入力

`$ARGUMENTS` = `--inline`

呼び出し元AIが直前の会話コンテキストに項目リストを保持している前提で動作する。
ファイルの読み込みは不要。

項目リストの推奨形式:
```markdown
1. **[項目タイトル]**: [説明]
2. **[項目タイトル]**: [説明]
...
```

> コンテキスト入力でもレビュー結果（🔴🟡🟢マーカー付き）を扱える。内容に応じて重大度列の表示や並び順が自動的に適用される。

---

## 提示ワークフロー

### Step 0: 入力の正規化 [MANDATORY]

入力方法に応じてデータを取得し、コンテンツ属性を判定する。

#### ファイル入力の場合

1. `$ARGUMENTS` で指定されたファイルを Read で読み込む
2. YAML frontmatter からメタデータを取得（review_type, engine, target_files, reference_docs, timestamp）
3. Markdown body から項目を抽出する

#### コンテキスト入力の場合

1. 直前の会話コンテキストから項目リストを取得する

#### コンテンツ属性の判定 [MANDATORY]

入力方法に関わらず、項目の内容から以下の属性を判定する:

| 属性 | 判定方法 | 影響 |
|------|---------|------|
| `has_severity` | 各項目の内容を理解し、項目間に重大度の差異があるかをAIが判断する | サマリー表の重大度列表示、並び順 |
| `has_metadata` | review_type, engine, reference_docs 等が利用可能か | サマリーヘッダ表示 |
| `is_code_review` | コードファイル参照（ファイル:行）や修正案が含まれるか | Step 4（Gemini補助）の提案 |

`has_severity = true` の場合、AIは各項目の内容から以下の重大度を付与する:

| 重大度 | 表示 | 基準 |
|--------|------|------|
| Critical | 🔴 | 放置すると重大な問題を引き起こす（バグ、セキュリティ、データ損失等） |
| Major | 🟡 | 品質・保守性に影響するが、即座の問題にはならない |
| Minor | 🟢 | 改善が望ましいが、現状でも許容範囲 |

> 入力に明示的なマーカーやラベル（🔴、[高]、致命的 等）が含まれていれば判断材料の一つとして活用するが、マーカーの有無自体は `has_severity` の判定条件ではない。🔴🟡🟢 はAIの判断結果を人間に伝える表示用マーカーである。

- ファイル入力: `has_metadata` は frontmatter から判定。他の属性は内容から判断
- コンテキスト入力: 全属性を内容から判断

> エラー時: ファイル不在・パースエラー・項目なし → ユーザーに報告して終了

### Step 1: 理解と評価 [MANDATORY]

1. 各項目を**深く理解する**
2. 各項目の✅判定を行う（後述「✅自明マークの判定基準」参照）
3. `has_severity` の場合: 各項目に重大度（Critical🔴 / Major🟡 / Minor🟢）を付与し、重大度順に並べ替え。ない場合: 番号順を維持
4. `has_metadata` で reference_docs がある場合: Read で読み込み、レビュー観点やルールを把握
5. target_files がある場合: 一覧を把握するのみ（各問題の提示時に該当箇所を Read）
6. 項目数をカウントし、提示準備

### Step 2: サマリー提示と進め方の選択

#### 1件の場合

Step 2 をスキップし、直接 Step 3 へ進む。
提示の原則に従って丁寧に提示し、「選択肢の提示方法」に従い AskUserQuestion で判断を仰ぐ。

#### 2件以上の場合

サマリーを提示し、ユーザーに進め方を確認する。

`has_metadata` がある場合、サマリーヘッダにメタデータを表示:
```
- レビュー種別: {review_type}
- エンジン: {engine}
```

`has_severity = true` の場合:
```
| # | 重大度 | 項目 | |
|---|--------|------|----|
| 1 | 🔴 | {問題1のタイトル} | |
| 2 | 🔴 | {問題2のタイトル} | ✅ |
| 3 | 🟡 | {問題3のタイトル} | ✅ |
| 4 | 🟢 | {問題4のタイトル} | |
```

`has_severity = false` の場合:
```
| # | 項目 | |
|---|------|----|
| 1 | {項目1のタイトル} | ✅ |
| 2 | {項目2のタイトル} | |
| 3 | {項目3のタイトル} | ✅ |
```

共通:
```
✅ = AIが自明と判断した修正（判定基準は「✅自明マークの判定基準」参照）
```

AskUserQuestion で進め方を確認する:

| # | 選択肢 | 説明 |
|---|--------|------|
| 1 | 段階的に解決 | 1件ずつ丁寧に説明し、判断を仰ぐ。`(Recommended)` を付加 |
| 2 | ✅を一括修正、残りは段階的に | ✅付き項目を自動修正し、残りは段階的に解決。✅が0件の場合は非表示 |
| 3 | 一覧で見る | 全項目の詳細を一括表示 |

### Step 3: 選択に応じた提示・解決フロー

#### 「段階的に解決」の場合

項目を順に**1件ずつ**提示する（`has_severity` なら🔴→🟡→🟢順、なければ番号順）。各項目で:

1. 項目を丁寧に説明する（提示の原則に従う）
2. 「選択肢の提示方法」に従い AskUserQuestion で判断を仰ぐ
3. ユーザーの選択に応じて:
   - **修正を選択**（A案/B案）→ `/kaizen:fix-staged --single` を呼び出し、修正を委譲（後述「/kaizen:fix-staged 呼び出し時の責務」参照）
   - **このまま（対応しない）** → Step 5 へ
   - **一覧に戻る** → Step 2 へ
4. fix-staged の修正サマリーをユーザーに報告
5. 次の項目へ進む

全項目の提示・解決が完了したら、修正サマリーを報告して終了。

#### 「✅を一括修正」の場合

1. ✅付き項目を収集し、`/kaizen:fix-staged --batch` を呼び出し、修正を委譲（後述「/kaizen:fix-staged 呼び出し時の責務」参照）
2. fix-staged の修正サマリーをユーザーに報告（項目ごとに何をしたか1行ずつ）
3. ✅なし項目が残っている場合、「段階的に解決」フローに移行
4. 全て✅だった場合は修正サマリーを報告して終了

#### 「一覧で見る」の場合

1. 全項目の詳細を一括表示
2. Step 2 のサマリー（進め方の選択）に戻る

### Step 4: 補助（オプション）

Step 3 完了後、`is_code_review` の場合に「最新のベストプラクティスを Web 検索で確認しますか？」を提案。
`ask-gemini` MCP を使用して Web 検索。`ask-gemini` が未接続の場合はこの Step をスキップする。

---

## /kaizen:fix-staged 呼び出し時の責務 [MANDATORY]

fix-staged に修正を委譲する際、以下を**漏れなく**渡すこと：

| 項目 | 必須 | 取得元 |
|------|------|--------|
| 指摘事項の詳細 | 必須 | review-result ファイル or コンテキスト |
| 対象ファイルパス | 必須 | review-result の target_files or 指摘事項の「箇所」 |
| レビュー種別 | 必須 | review-result の review_type or コンテキストから判定 |
| ユーザーが選択した修正方針 | あれば | AskUserQuestion の回答（A案/B案等） |

> fix-staged の入力仕様の詳細は `${CLAUDE_PLUGIN_ROOT}/skills/fix-staged/SKILL.md` を参照。

> **--inline モードの場合**: review_type が frontmatter から取得できない。呼び出し元 AI がコンテキストから種別を判断する。判断できない場合は `generic` をフォールバックとして使用する。

---

## ファイル永続化

入力方法に関わらず、修正を伴う項目がある場合は `.claude/.temp/` にファイルを保存できる。

| 入力方法 | ファイル |
|----------|---------|
| ファイル入力 | 元のファイルは Read のみで変更されないため、初期状態として参照可能 |
| コンテキスト入力 | 修正開始時に `.claude/.temp/present-staged-{YYYYMMDD-HHmmss}.md` に保存 |

ファイル永続化の目的:
- 修正後の再レビューが可能
- コンテキスト圧縮後の項目リスト復元が可能
- 長時間の対話でも初期状態を参照可能

保存形式は入力仕様のファイル入力形式に準拠（YAML frontmatter + Markdown body）。
コンテキスト入力の場合、利用可能なメタデータを frontmatter に含める。

---

## 提示の原則 [MANDATORY]

元の情報を**そのまま転記してはならない**。

`/present-staged` はプレゼンターである。各項目を**自分で理解した上で**、ユーザーが納得できるよう丁寧に説明する。

内容が不明確な場合は、その旨をユーザーに伝え、一緒に確認する提案をする。推測で説明しない。

### 具体的なプレゼン手法

| 手法 | 説明 | いつ使うか |
|------|------|-----------|
| コード表示 | 該当箇所を Read で読み込み、問題のあるコードを表示 | コードに関する項目 |
| 比較表 | 修正前/修正後、オプションA/Bを表で対比 | 比較・選択がある場合 |
| 影響範囲の説明 | 影響・リスク・メリットを説明 | 全ての項目 |
| ルール・根拠の引用 | reference_docs やソースから根拠を引用 | 根拠が必要な場合 |
| 正しいパターン | プロジェクトの既存コードから正しい実装例を探して提示 | コードレビュー時 |

### 選択肢の提示方法 [MANDATORY]

ユーザーに選択を求める全ての場面で **AskUserQuestion ツール** を使用する。
テキストで「A / B」のように選択肢を記述しない。

#### テキスト出力と AskUserQuestion の分離 [MANDATORY]

AskUserQuestion の UI はテキスト出力の末尾に重なって表示される。
以下のルールで重要情報の可読性を確保すること:

1. **説明テキストの末尾は短い要約文（1-2行）で締める** — コードブロック・表・引用で終わらせない
2. **要約文の後に `---`（区切り線）を入れる** — 視覚的にテキストと UI を分離
3. **AskUserQuestion は区切り線の後に呼び出す**

構成:
```
詳細説明（コードブロック、表、根拠の引用など）
↓
短い要約文（推奨アクションを1-2行で）
↓
---（区切り線）
↓
AskUserQuestion 呼び出し
```

#### 対応判断が必要な項目の場合

| # | 選択肢 | 説明 |
|---|--------|------|
| 1 | A案の内容 | 推奨する対応案。1番目に配置し `(Recommended)` を付加 |
| 2 | B案の内容 | 代替案がある場合のみ追加 |
| 3 | 一覧に戻る | サマリー一覧を再表示し、別の項目を選択可能にする |
| 4 | このまま（対応しない） | この項目をスキップして次へ進む |

- 代替案がない場合は A案 + 一覧に戻る + このまま の3択
- 「Other」が自動提供されるため、質問・別案の提示はそこでカバーされる

#### 情報確認のみの項目の場合

| # | 選択肢 | 説明 |
|---|--------|------|
| 1 | 次へ | 次の項目へ進む |
| 2 | 一覧に戻る | サマリー一覧を再表示 |
| 3 | 終了 | 残り項目数を案内して提示を終了 |

### ✅自明マークの判定基準

Step 1 で各項目を評価し、以下を**全て**満たす場合に ✅ を付ける:

| 条件 | 説明 |
|------|------|
| 修正が一意 | 選択肢がなく、修正内容が1通りに決まる |
| 影響が局所的 | 他の項目や設計判断に波及しない |
| 機械的に修正可能 | 判断・設計決定を伴わない |

**✅の例**: 末尾スペース削除、タイポ修正、未使用importの削除、単純な置換
**✅にしない例**: アーキテクチャ変更、複数の対応案がある問題、影響範囲が広い修正

**判断に迷ったら ✅ を付けない**（対話3原則: 不明確なことは勝手に決めない）

### 段階的解決の提示例

````markdown
## 🔴 問題 1/3: Actor 隔離違反

`FooViewModel` の `fetchItems()` が `@MainActor` 上で重い処理を実行しています。

### 該当箇所

`App/ViewModel/FooViewModel.swift:42-58`
```swift
@MainActor
func fetchItems() async throws {
    let items = try await repository.fetchItems()  // ← ここでUIスレッドがブロック
    self.items = items
}
```

### なぜ問題か

UIスレッドがブロックされ、ユーザー操作が固まります。
プロジェクトのアーキテクチャルール「Actor 隔離原則」に違反しています:

> 重い処理は非UIスレッドで実行し、結果のみ @MainActor で受け取る

### 修正案

| 現在 | 修正後 |
|------|--------|
| `@MainActor` で直接API呼び出し | Service で処理し、結果のみ `@MainActor` で反映 |

```swift
// 修正後
func fetchItems() async throws {
    let items = try await service.fetchItems()  // Service で処理
    await MainActor.run {
        self.items = items  // UIスレッドで結果のみ反映
    }
}
```

Service レイヤーに処理を移し、`@MainActor` では結果反映のみとする修正を推奨します。

---

→ AskUserQuestion で判断を仰ぐ（「選択肢の提示方法」参照）
````

---

## 対話3原則

1. **不明確なことは勝手に決めない** → ユーザーに問い合わせる
2. **問題や提案の比較・経緯を丁寧に説明する**
3. **全ての問題を一度に提示しない** → 段階的に説明して判断を仰ぐ

---

## 提示数制限

| 条件 | 上限 | 超過時の対応 |
|------|------|-------------|
| `has_severity` — 🔴致命的 | 10件 | 超過分は次回レビューへ |
| `has_severity` — 🟡品質 | 10件 | 超過分は次回レビューへ |
| `has_severity` — 🟢改善 | 5件 | 超過分は省略 |
| 重大度なし | 20件 | 「残りN件あります。続けますか？」と確認 |

> 項目は全件保存される（カットしない）。
> 上限を超える場合は、提示時に超過分の案内をする。

---

## エラーハンドリング

| エラー | 対応 |
|--------|------|
| ファイルが存在しない | 「ファイルが見つかりません: {path}」と表示して終了 |
| YAML frontmatter パースエラー | 「ファイルの形式が不正です」と表示して終了 |
| frontmatter の必須フィールド不足 | 不足フィールドを報告し、利用可能な情報で続行 |
| 項目が0件 | 「提示する項目がありません」と表示して終了 |
| コンテキストに項目が見つからない | 「提示する項目が見つかりません」と表示して終了 |
| fix-staged がエラーを返した | エラー内容をユーザーに報告し、手動対応するか確認（AskUserQuestion） |
